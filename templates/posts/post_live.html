<script>
function createOrUpdate(slug) {
    var existing = document.getElementById(slug.id);
    if (!existing) {
        container.innerHTML += slug.html;
        notificationCount += 1;
        document.title = originalTitle + " (" + notificationCount + ")";
    } else {
        existing.outerHTML = slug.html;
    }
}
function load() {
    var atBottom = window.scrollY + window.innerHeight > latest.offsetTop;
    JSON.parse(this.response).forEach(createOrUpdate);
    latest.innerHTML = (new Date()).toISOString();
    if (!document.hidden & atBottom) {
        latest.scrollIntoView();
        notificationCount = 0;
        document.title = originalTitle;
    }
}
function query(isSubmission) {
    var payload = "topic={{topic.id}}"
    payload += "&csrfmiddlewaretoken="+quick.csrfmiddlewaretoken.value;
    payload += "&timestamp="+latest.innerHTML;
    if (isSubmission) {
        payload += "&content="+quick.content.value;
        quick.content.value = '';
    }
    var xhr = new XMLHttpRequest();
    xhr.open("post", "{% url 'posts-ajax' topic.id %}", true);
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhr.send(payload);
    xhr.onload = load;
    return false
}
var originalTitle = document.title;
var notificationCount = 0;
window.setInterval(query, 5000);
</script>
